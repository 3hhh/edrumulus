

##% mean_neighbor_x:
##x = [701.85 700.00 1 686.35 1.10
##1101.81 700.00 9 546.77 12.67
##1178.78 700.00 9 511.76 11.86
##1206.76 700.00 11 568.22 44.86
##1724.69 700.00 12 547.13 86.67
##1716.61 700.00 13 484.07 162.71
##1830.59 700.00 14 389.94 294.04
##1830.53 700.00 14 324.86 244.96
##1830.44 700.00 12 626.32 99.22
##1406.39 700.00 11 321.88 25.41
##1830.44 700.00 14 421.27 317.66
##1334.44 700.00 11 619.38 48.89
##1410.45 700.00 11 496.88 39.22
##1030.46 700.00 9 579.92 13.44
##940.47 700.00 7 638.95 5.43
##1109.46 700.00 8 652.94 8.91
##908.61 700.00 7 633.59 5.38
##909.62 700.00 7 646.60 5.49
##1140.64 700.00 10 523.11 21.76
##966.65 700.00 7 664.63 5.65
##1106.67 700.00 8 661.11 9.02
##1044.66 700.00 8 648.61 8.85
##1021.64 700.00 7 687.60 5.84
##1080.63 700.00 9 495.09 11.47
##1088.62 700.00 9 546.58 12.66
##1284.59 700.00 9 596.55 13.82
##742.67 700.00 3 684.67 1.53
##852.69 700.00 6 681.18 3.81
##1094.69 700.00 10 558.16 23.21
##841.71 700.00 7 614.69 5.22
##1020.69 700.00 9 585.67 13.57
##1182.66 700.00 11 326.65 25.79
##1204.67 700.00 10 551.16 22.92
##1157.67 700.00 9 647.15 14.99
##870.70 700.00 6 676.69 3.79
##833.77 700.00 5 693.25 2.70
##798.78 700.00 5 652.78 2.54
##1025.87 700.00 8 675.34 9.22
##870.85 700.00 6 669.35 3.75
##1097.82 700.00 9 638.78 14.80
##1142.78 700.00 10 573.25 23.84
##1329.77 700.00 11 670.70 52.95
##1462.72 700.00 12 652.68 103.39
##1458.70 700.00 13 413.66 139.04
##772.78 700.00 5 622.28 2.42
##737.79 700.00 3 678.79 1.51
##764.80 700.00 5 627.30 2.44
##774.80 700.00 5 638.30 2.49
##892.82 700.00 7 632.30 5.37
##980.82 700.00 8 616.29 8.41
##881.81 700.00 7 614.30 5.22
##813.80 700.00 6 617.80 3.46
##840.81 700.00 6 621.31 3.48
##726.83 700.00 3 666.34 1.49
##998.95 700.00 8 646.92 8.83
##978.94 700.00 8 551.43 7.52
##1006.91 700.00 8 643.40 8.78
##980.91 700.00 8 601.91 8.21
##716.96 700.00 2 684.95 1.26
##1190.95 700.00 11 541.41 42.74
##1613.94 700.00 12 590.35 93.52
##1014.91 700.00 8 685.89 9.36
##920.94 700.00 7 637.42 5.42
##943.93 700.00 7 651.91 5.54
##810.93 700.00 5 672.93 2.62
##902.95 700.00 7 587.43 4.99
##726.94 700.00 3 668.94 1.49
##710.97 700.00 1 686.97 1.10
##710.98 700.00 2 672.49 1.23
##903.00 700.00 7 578.48 4.92
##846.97 700.00 6 651.46 3.64
##1019.97 700.00 8 651.94 8.90
##1005.99 700.00 8 540.47 7.38
##1040.98 700.00 8 639.45 8.73
##858.99 700.00 6 649.48 3.63
##843.00 700.00 6 634.49 3.55
##907.00 700.00 7 617.98 5.25
##872.99 700.00 6 644.48 3.61
##827.98 700.00 6 643.97 3.60
##783.39 700.00 4 682.38 1.96
##831.41 700.00 6 599.90 3.36
##801.41 700.00 5 669.90 2.61
##894.41 700.00 7 568.39 4.83
##953.40 700.00 7 626.88 5.33
##981.40 700.00 8 563.37 7.69
##847.39 700.00 6 630.38 3.53
##759.38 700.00 4 660.39 1.89
##798.39 700.00 5 642.89 2.50
##855.40 700.00 6 656.39 3.67
##871.42 700.00 6 645.91 3.61
##911.56 700.00 7 601.04 5.11
##802.55 700.00 6 613.06 3.43
##1063.55 700.00 9 671.51 15.56
##1054.50 700.00 9 665.99 15.43
##1367.45 700.00 12 494.42 78.32
##1367.43 700.00 12 499.88 79.19
##1083.39 700.00 9 616.37 14.28
##751.40 700.00 4 660.91 1.89
##732.40 700.00 3 681.90 1.52
##820.50 700.00 5 646.51 2.52
##839.50 700.00 5 673.00 2.62
##1137.48 700.00 9 681.97 15.80
##1421.46 700.00 12 575.91 91.23
##795.50 700.00 6 664.98 3.72
##983.48 700.00 8 666.95 9.10
##1142.44 700.00 11 514.93 40.65
##1094.44 700.00 10 577.91 24.04
##1269.43 700.00 11 578.89 45.70
##1277.39 700.00 12 490.87 77.76
##1367.40 700.00 12 556.35 88.13
##1559.37 700.00 12 631.78 100.08
##958.36 700.00 8 616.36 8.41
##1283.36 700.00 11 597.32 47.15
##796.43 700.00 5 693.42 2.70
##1103.42 700.00 10 548.89 22.83
##743.46 700.00 3 681.46 1.52
##700.49 700.00 1 677.99 1.08
##774.50 700.00 5 640.00 2.49
##1067.51 700.00 9 630.97 14.62
##917.51 700.00 7 661.49 5.62
##854.51 700.00 6 646.50 3.62
##1367.45 700.00 12 527.40 83.55
##945.45 700.00 8 556.44 7.59
##1285.45 700.00 11 601.38 47.47
##1039.39 700.00 8 617.89 8.43
##802.43 700.00 5 654.42 2.55
##1107.40 700.00 9 603.39 13.98
##731.66 700.00 3 680.14 1.52
##791.66 700.00 5 658.65 2.57
##1143.62 700.00 10 636.60 26.48
##1575.59 700.00 13 523.03 175.80
##1477.55 700.00 13 488.48 164.19
##1335.48 700.00 12 508.95 80.63
##1019.48 700.00 9 598.47 13.87
##1111.50 700.00 9 628.96 14.57
##716.52 700.00 3 671.03 1.50
##1070.55 700.00 9 526.51 12.20
##727.50 700.00 3 680.00 1.52
##786.51 700.00 5 649.01 2.53
##743.52 700.00 3 685.53 1.53
##1062.52 700.00 9 632.98 14.67
##887.49 700.00 7 607.50 5.16
##1311.47 700.00 11 594.43 46.92
##1152.41 700.00 9 686.89 15.91
##881.41 700.00 7 596.41 5.07
##775.41 700.00 4 658.41 1.89
##815.40 700.00 5 656.91 2.56
##1023.40 700.00 8 663.37 9.05
##830.38 700.00 5 671.38 2.61
##877.37 700.00 6 668.36 3.74
##1463.35 700.00 11 656.78 51.85];

x = [1025.33 700.00 8 407.35 5.56
1192.32 700.00 9 627.78 14.54
804.60 700.00 4 689.07 1.98
794.57 700.00 4 683.59 1.96
1071.58 700.00 8 534.07 7.29
1362.48 700.00 11 495.48 39.11
1346.50 700.00 10 549.48 22.85
1754.45 700.00 13 401.91 135.09
1722.40 700.00 12 520.34 82.43
1514.40 700.00 11 570.35 45.02
1190.39 700.00 10 599.89 24.95
1153.38 700.00 9 644.89 14.94
986.43 700.00 6 672.90 3.76
877.44 700.00 5 662.44 2.58
778.52 700.00 3 666.52 1.49
920.51 700.00 7 594.49 5.05
1146.48 700.00 10 556.45 23.14
1271.41 700.00 11 629.40 49.69
916.48 700.00 7 664.97 5.65
1169.47 700.00 10 641.94 26.70
1226.45 700.00 11 582.91 46.02
1017.46 700.00 8 629.45 8.59
869.45 700.00 5 650.96 2.54
851.47 700.00 5 642.47 2.50
1105.46 700.00 8 644.95 8.80
746.49 700.00 4 644.98 1.85
792.52 700.00 6 634.03 3.55
720.55 700.00 2 682.55 1.25
914.55 700.00 7 574.55 4.88
816.75 700.00 7 496.25 4.22
701.72 700.00 1 682.72 1.09
762.72 700.00 3 659.22 1.47
784.72 700.00 5 618.70 2.41
848.74 700.00 5 624.72 2.43
871.71 700.00 6 643.71 3.60
825.71 700.00 5 633.71 2.47
753.73 700.00 3 643.23 1.44
858.71 700.00 6 640.20 3.58
734.71 700.00 3 630.21 1.41
826.67 700.00 5 677.67 2.64
741.66 700.00 3 648.66 1.45
744.63 700.00 3 647.65 1.44
704.65 700.00 1 694.15 1.11
848.59 700.00 7 601.09 5.11
863.53 700.00 4 698.55 2.00
972.52 700.00 6 665.52 3.72
855.53 700.00 7 606.01 5.15
778.52 700.00 4 630.01 1.81
1018.49 700.00 8 626.46 8.55
904.44 700.00 6 679.94 3.80
922.43 700.00 6 642.42 3.59
1050.42 700.00 8 655.40 8.94
933.43 700.00 6 656.40 3.67
1026.37 700.00 8 605.38 8.26
986.35 700.00 8 619.37 8.45
985.40 700.00 6 673.87 3.77
823.36 700.00 5 606.36 2.36
729.40 700.00 3 698.40 1.56
721.39 700.00 4 661.88 1.90
838.36 700.00 5 638.36 2.49
768.36 700.00 5 663.86 2.59
1146.30 700.00 10 555.30 23.10
1126.30 700.00 9 626.76 14.52
1170.28 700.00 9 663.25 15.37
1146.27 700.00 9 612.23 14.18
1162.23 700.00 10 627.20 26.09
1186.16 700.00 11 528.65 41.73
1056.15 700.00 9 586.13 13.58
947.15 700.00 6 633.64 3.55
819.17 700.00 4 696.66 2.00
746.16 700.00 3 685.16 1.53
986.14 700.00 8 512.61 7.00
839.14 700.00 5 639.62 2.49
1238.13 700.00 9 650.56 15.07
1139.08 700.00 9 633.57 14.68
1367.07 700.00 11 631.00 49.81
1306.00 700.00 11 570.97 45.07
1109.04 700.00 9 617.00 14.30
860.08 700.00 6 633.08 3.54
874.14 700.00 5 667.14 2.60
1342.07 700.00 11 492.06 38.84
1186.06 700.00 11 558.55 44.09
1328.03 700.00 12 501.00 79.37
1306.01 700.00 11 478.98 37.81
1102.02 700.00 9 603.49 13.98
1332.02 700.00 11 440.47 34.77
1609.95 700.00 13 461.91 155.26
1258.19 700.00 10 654.67 27.23
858.30 700.00 5 612.82 2.39
858.36 700.00 7 543.34 4.62
979.36 700.00 8 560.33 7.65
1270.33 700.00 10 604.78 25.15
1364.29 700.00 12 452.75 71.72
977.33 700.00 7 680.81 5.79
1127.26 700.00 9 623.27 14.44
1290.24 700.00 11 482.70 38.10
1393.24 700.00 11 529.66 41.81
1136.23 700.00 9 572.19 13.26
895.23 700.00 6 586.72 3.28
838.28 700.00 6 617.78 3.46
724.27 700.00 2 679.28 1.25
864.30 700.00 6 651.82 3.65
920.32 700.00 7 581.80 4.94
912.31 700.00 6 672.80 3.76
773.30 700.00 5 591.79 2.30
794.32 700.00 3 653.30 1.46
793.30 700.00 3 682.30 1.52
806.33 700.00 5 628.31 2.45
746.39 700.00 3 683.39 1.52
840.40 700.00 5 662.89 2.58
930.39 700.00 6 669.36 3.75
1022.36 700.00 8 562.83 7.68
1063.37 700.00 8 420.34 5.74
1146.31 700.00 7 679.79 5.78
1113.31 700.00 8 655.78 8.95
1242.30 700.00 10 390.75 16.25
1300.24 700.00 11 515.20 40.67
1274.22 700.00 11 553.66 43.71
1306.19 700.00 11 514.62 40.62
1406.16 700.00 10 640.07 26.62
1408.09 700.00 11 675.55 53.33
1045.10 700.00 8 585.59 7.99
794.25 700.00 5 652.71 2.54
789.22 700.00 4 690.21 1.98
911.17 700.00 6 690.18 3.86
970.19 700.00 6 678.66 3.80
794.18 700.00 5 659.68 2.57
890.16 700.00 7 622.64 5.29
933.13 700.00 8 582.13 7.94
749.14 700.00 4 663.13 1.90
762.28 700.00 5 549.27 2.14
870.26 700.00 5 668.24 2.60
733.26 700.00 3 648.76 1.45
896.24 700.00 6 679.23 3.80
734.24 700.00 2 694.73 1.28
778.28 700.00 4 648.27 1.86
846.29 700.00 5 657.77 2.56
935.41 700.00 8 607.41 8.29
730.45 700.00 3 676.94 1.51
956.41 700.00 8 574.91 7.85
1252.37 700.00 11 495.35 39.10
1415.36 700.00 10 641.30 26.67
1530.29 700.00 12 446.27 70.70
1178.29 700.00 10 583.26 24.26
1194.28 700.00 10 547.75 22.78
1194.25 700.00 9 623.73 14.45
1018.23 700.00 8 585.22 7.99
1474.19 700.00 12 570.63 90.40
927.20 700.00 8 630.67 8.61
989.17 700.00 8 588.16 8.03
1190.15 700.00 10 548.12 22.80
984.14 700.00 7 660.12 5.61
750.19 700.00 4 680.70 1.95
727.18 700.00 2 690.69 1.27
1018.17 700.00 7 535.18 4.55
1049.38 700.00 8 650.32 8.87
890.39 700.00 5 658.89 2.57
938.38 700.00 7 596.40 5.07
752.43 700.00 3 673.94 1.50
945.40 700.00 7 652.40 5.54
1178.39 700.00 9 670.87 15.54
1082.35 700.00 9 575.34 13.33
1009.34 700.00 8 592.84 8.09
1192.34 700.00 9 666.30 15.44
1228.28 700.00 10 607.75 25.28
1098.28 700.00 9 576.26 13.35
1050.27 700.00 7 629.26 5.35
837.30 700.00 6 619.79 3.47
858.31 700.00 7 590.79 5.02
813.35 700.00 5 618.33 2.41
917.42 700.00 7 626.38 5.32
826.42 700.00 4 659.42 1.89
823.44 700.00 6 649.93 3.64
880.42 700.00 6 625.41 3.50
842.39 700.00 6 674.38 3.77
954.38 700.00 6 658.87 3.69
961.42 700.00 6 632.39 3.54
794.39 700.00 6 603.90 3.38];

close all;

[~, idx] = sort(x(:,1));
x = x(idx,:);

%figure; plot(x);

y = x;

%y(:,2) = y(:,2) .* (y(:,5) .^ (1 / 6));
%figure; plot(y(:, 1:2)); grid on; hold on;


% amplification_compensation = amplification_mapping[min ( length_ampmap - 1, 1 + number_overloaded_samples )] * mean_neighbor / new_clip_level;

ampmap_const_step     = 0.05; % PD80R
clip_limit            = 700;
amplification_mapping = transpose(10 .^ ([0:ampmap_const_step:ampmap_const_step * 20] .^ 2));
amplification_compensation = amplification_mapping(2 + y(:, 3)) .* y(:, 4) ./ clip_limit;

%figure; plot(20 * log10(700:2000), 20 * log10(700:2000), 'k-.');
%xlabel('true'); ylabel('est'); grid on; hold on;
%plot(20 * log10(y(:, 1)), 20 * log10(clip_limit * amplification_compensation));

figure; plot(500:2000, 500:2000, 'k-.'); axis([500, 2000, 500, 2000]);
xlabel('true'); ylabel('est'); grid on; hold on;
plot(y(:, 1), clip_limit * amplification_compensation);

%figure; plot(y(:, 1)); grid on; hold on;
%plot(clip_limit * amplification_compensation, 'g')
%plot(y(:, 4), 'r')

%plot(amplification_compensation); grid on; hold on; plot(y(:, 5))
%plot(20 * log10(amplification_compensation)); grid on; hold on; plot(20 * log10(y(:, 5)))


%figure;plot(y(:,3))




